{% extends "base.html" %}

{% block title %}Konvertuesi - Konvertuesi i Ekstrakteve Bankare Shqiptare{% endblock %}

{% block page_title %}Konvertuesi i Ekstrakteve Bankare{% endblock %}

{% block extra_css %}
<style>
    .converter-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .converter-card {
        background: white;
        border-radius: var(--border-radius);
        border: 1px solid var(--gray-200);
        box-shadow: var(--shadow-md);
        padding: var(--spacing-xl);
        margin-bottom: var(--spacing-xl);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-sm);
        border-bottom: 2px solid var(--gray-100);
    }

    .upload-area {
        border: 2px dashed var(--gray-300);
        border-radius: var(--border-radius);
        padding: 2rem;
        text-align: center;
        transition: all var(--transition-fast);
        cursor: pointer;
        background: var(--gray-50);
    }

    .upload-area:hover,
    .upload-area.drag-over {
        border-color: var(--primary-color);
        background: var(--primary-light);
    }

    .upload-icon {
        font-size: 2rem;
        color: var(--gray-400);
        margin-bottom: var(--spacing-sm);
    }

    .bank-select {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        border: 2px solid var(--gray-300);
        border-radius: var(--border-radius);
        background: white;
        color: var(--gray-900);
        cursor: pointer;
        transition: all var(--transition-fast);
    }

    .bank-select:hover {
        border-color: var(--primary-color);
    }

    .bank-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px var(--primary-light);
    }

    .progress-container {
        display: none;
        margin-top: var(--spacing-xl);
        padding: var(--spacing-lg);
        background: var(--gray-50);
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--gray-200);
    }

    .progress-bar {
        height: 10px;
        background: var(--gray-200);
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: var(--spacing-md);
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--gray-700), var(--gray-900));
        transition: width 0.3s ease;
        border-radius: 5px;
    }

    .progress-text {
        font-size: 0.875rem;
        color: var(--gray-700);
        text-align: center;
        font-weight: 500;
    }

    .result-container {
        display: none;
        margin-top: var(--spacing-xl);
        padding-top: var(--spacing-xl);
        border-top: 2px solid var(--gray-200);
    }

    .result-success {
        background: linear-gradient(135deg, var(--gray-800), var(--gray-700));
        color: white;
        padding: var(--spacing-xl);
        border-radius: var(--border-radius);
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .result-success h3 {
        font-size: 1.5rem;
        margin-bottom: var(--spacing-lg);
        font-weight: 600;
    }

    .result-error {
        background: linear-gradient(135deg, var(--gray-700), var(--gray-600));
        color: white;
        padding: var(--spacing-xl);
        border-radius: var(--border-radius);
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .file-info {
        display: none;
        background: var(--gray-100);
        padding: var(--spacing-md);
        border-radius: var(--border-radius-sm);
        margin-top: var(--spacing-md);
    }

    .file-name {
        font-weight: 500;
        color: var(--gray-900);
    }

    .file-size {
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .convert-btn {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        font-weight: 600;
    }

    .convert-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .action-section {
        padding-top: var(--spacing-lg);
        margin-top: var(--spacing-lg);
        border-top: 1px solid var(--gray-200);
    }

    .download-btn {
        display: inline-block;
        padding: 0.875rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        border-radius: var(--border-radius-sm);
        transition: all var(--transition-fast);
        margin: var(--spacing-md);
    }

    .btn-download-primary {
        background: white;
        color: var(--gray-900);
        border: 2px solid white;
    }

    .btn-download-primary:hover {
        background: var(--gray-100);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .btn-reset {
        background: var(--gray-200);
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
    }

    .btn-reset:hover {
        background: var(--gray-300);
        color: var(--gray-900);
    }

    .info-section {
        background: var(--gray-50);
        border-left: 4px solid var(--info-color);
        padding: var(--spacing-lg);
        border-radius: var(--border-radius-sm);
        margin-top: var(--spacing-xl);
    }

    .info-title {
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: var(--spacing-sm);
    }

    .info-list {
        list-style: none;
        padding-left: 0;
    }

    .info-list li {
        padding: var(--spacing-xs) 0;
        color: var(--gray-700);
    }

    .info-list li:before {
        content: "âœ“";
        color: var(--success-color);
        font-weight: bold;
        margin-right: var(--spacing-sm);
    }

    .privacy-notice {
        background: var(--gray-100);
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-sm);
        padding: var(--spacing-md);
        margin-top: var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-size: 0.875rem;
        color: var(--gray-700);
    }

    .privacy-notice i {
        color: var(--gray-600);
        font-size: 1.25rem;
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="converter-container">
    <!-- Upload Card -->
    <div class="converter-card">
        <h2 class="section-title">Ngarko Statement</h2>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ðŸ“„</div>
            <h3 style="margin-bottom: var(--spacing-sm);">Vendos dokumentin kÃ«tu</h3>
            <p style="color: var(--gray-600); margin-bottom: var(--spacing-md);">ose kliko pÃ«r tÃ« zgjedhur</p>
            <input type="file" id="fileInput" accept=".pdf,.csv,.xls,.xlsx" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                Zgjidh Skedarin
            </button>
        </div>

        <div class="file-info" id="fileInfo">
            <div class="file-name" id="fileName"></div>
            <div class="file-size" id="fileSize"></div>
        </div>
    </div>

    <!-- Bank Selection Card -->
    <div class="converter-card">
        <h2 class="section-title">Zgjidh BankÃ«n</h2>

        <select id="bankSelect" class="bank-select" onchange="selectBank(this.value)">
            <option value="">Zgjidh njÃ« bankÃ«...</option>
            {% for bank_id, bank_info in banks.items() %}
            <option value="{{ bank_id }}">{{ bank_info.name }} ({{ bank_info.formats|join(', ') }})</option>
            {% endfor %}
        </select>

        <!-- Convert Action -->
        <div class="action-section">
            <button class="btn btn-primary convert-btn" id="convertBtn" disabled onclick="convertFile()">
                Konverto Statement
            </button>

            <!-- Progress -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">Duke konvertuar...</div>
            </div>

            <!-- Result -->
            <div class="result-container" id="resultContainer"></div>
        </div>
    </div>

    <!-- Info Section -->
    <div class="info-section">
        <div class="info-title">VeÃ§oritÃ« e MbÃ«shtetura:</div>
        <ul class="info-list">
            <li>Konverto ekstraktet bankare PDF dhe CSV nÃ« formatin QuickBooks dhe Wave Accounting</li>
            <li>MbÃ«shtetje pÃ«r bankat kryesore shqiptare (Raiffeisen, Intesa, ProCredit, etj.)</li>
            <li>Proces konvertimi i shpejtÃ« dhe i sigurt</li>
            <li>Shkarko skedarÃ«t e konvertuar menjÃ«herÃ«</li>
        </ul>
    </div>

    <!-- Privacy Notice -->
    <div class="privacy-notice">
        <i class="fas fa-shield-alt"></i>
        <span>Sistemi nuk ruan kopje tÃ« statement-eve tuaj. TÃ« gjitha skedarÃ«t fshihen automatikisht pasi tÃ« jenÃ« shkarkuar.</span>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;
let selectedBank = null;
let currentJobId = null;

// File upload handling
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const convertBtn = document.getElementById('convertBtn');

// Drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');

    if (e.dataTransfer.files.length > 0) {
        handleFileSelect(e.dataTransfer.files[0]);
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    selectedFile = file;

    // Display file info
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    fileInfo.style.display = 'block';

    // Update convert button state
    updateConvertButton();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Bank selection
function selectBank(bankId) {
    selectedBank = bankId;

    // Update convert button state
    updateConvertButton();
}

function updateConvertButton() {
    convertBtn.disabled = !(selectedFile && selectedBank);
}

// Reset form for new conversion
function resetForm() {
    // Clear file input
    fileInput.value = '';
    selectedFile = null;

    // Hide file info
    fileInfo.style.display = 'none';

    // Reset bank dropdown
    document.getElementById('bankSelect').value = '';
    selectedBank = null;

    // Re-enable upload area
    uploadArea.style.pointerEvents = '';
    uploadArea.classList.remove('drag-over');

    // Disable convert button
    convertBtn.disabled = true;

    // Hide result section
    document.getElementById('resultContainer').style.display = 'none';
    document.getElementById('progressContainer').style.display = 'none';

    // Reset current job
    currentJobId = null;
}

// Convert file
async function convertFile() {
    if (!selectedFile || !selectedBank) {
        alert('Ju lutem zgjidhni njÃ« skedar dhe njÃ« bankÃ«');
        return;
    }

    // Show progress
    document.getElementById('progressContainer').style.display = 'block';
    document.getElementById('resultContainer').style.display = 'none';
    convertBtn.disabled = true;

    // Create form data
    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('bank', selectedBank);

    try {
        // Upload and convert
        const response = await fetch('/convert', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            currentJobId = result.job_id;
            pollConversionStatus();
        } else {
            showError(result.error || 'Konvertimi dÃ«shtoi');
        }
    } catch (error) {
        showError('Gabim nÃ« rrjet: ' + error.message);
    }
}

// Poll conversion status
async function pollConversionStatus() {
    try {
        const response = await fetch(`/status/${currentJobId}`);
        const result = await response.json();

        if (result.status === 'completed') {
            showSuccess('Konvertimi pÃ«rfundoi!', result.files);
        } else if (result.status === 'failed') {
            showError(result.error || 'Konvertimi dÃ«shtoi');
        } else {
            // Still processing, poll again
            setTimeout(pollConversionStatus, 1000);
        }
    } catch (error) {
        showError('Gabim nÃ« kontroll tÃ« statusit: ' + error.message);
    }
}

function showSuccess(message, files) {
    document.getElementById('progressContainer').style.display = 'none';

    const resultContainer = document.getElementById('resultContainer');
    resultContainer.style.display = 'block';
    resultContainer.innerHTML = `
        <div class="result-success">
            <h3>âœ“ ${message}</h3>
            <div style="display: flex; gap: var(--spacing-md); justify-content: center; flex-wrap: wrap; align-items: center;">
                ${files.map(file => `
                    <a href="/download/${currentJobId}/${file}" class="download-btn btn-download-primary">
                        <i class="fas fa-download"></i> Shkarko CSV
                    </a>
                `).join('')}
                <button onclick="resetForm()" class="download-btn btn-reset">
                    <i class="fas fa-arrow-rotate-right"></i> Konverto TjetÃ«r
                </button>
            </div>
        </div>
    `;

    convertBtn.disabled = false;
}

function showError(message) {
    document.getElementById('progressContainer').style.display = 'none';

    const resultContainer = document.getElementById('resultContainer');
    resultContainer.style.display = 'block';
    resultContainer.innerHTML = `
        <div class="result-error">
            <h3 style="margin-bottom: var(--spacing-md);">âœ— Gabim</h3>
            <p>${message}</p>
        </div>
    `;

    convertBtn.disabled = false;
}
</script>
{% endblock %}
