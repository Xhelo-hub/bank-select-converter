{% extends "base.html" %}

{% block title %}Email Settings - Admin Panel{% endblock %}
{% block page_title %}Email Settings{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    .section {
        background: var(--surface-alt);
        border-radius: var(--border-radius-sm);
        padding: 28px;
        margin-bottom: 20px;
        border: 1px solid var(--border-light);
    }

    .section-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section-title i { color: var(--primary); }

    .form-group { margin-bottom: 20px; }

    .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 6px;
        color: var(--text);
        font-size: 13px;
    }

    .form-group .help-text {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
    }

    .form-control {
        width: 100%;
        padding: 10px 14px;
        border: 1.5px solid var(--border);
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s ease;
        background: var(--surface);
        color: var(--text);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-row {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 15px;
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px;
        background: var(--surface);
        border-radius: var(--border-radius-sm);
        border: 1.5px solid var(--border);
    }

    .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: var(--primary);
    }

    .checkbox-group label {
        margin: 0;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-group {
        display: flex;
        gap: 12px;
        margin-top: 28px;
    }

    .btn {
        padding: 10px 24px;
        border: none;
        border-radius: var(--border-radius-sm);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        justify-content: center;
        font-family: inherit;
    }

    .btn:hover { transform: translateY(-1px); }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }

    .btn-secondary {
        background: var(--text-secondary);
        color: white;
    }

    .btn-secondary:hover {
        background: #475569;
    }

    .btn-test {
        background: #0891b2;
        color: white;
    }

    .btn-test:hover {
        background: #0e7490;
        box-shadow: 0 4px 12px rgba(8, 145, 178, 0.3);
    }

    .test-result {
        margin-top: 15px;
        padding: 12px 16px;
        border-radius: var(--border-radius-sm);
        display: none;
        animation: slideIn 0.3s ease;
        font-size: 13px;
        font-weight: 500;
    }

    @keyframes slideIn {
        from { transform: translateY(-8px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .test-result.success { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .test-result.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

    .provider-presets {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .preset-btn {
        padding: 8px 16px;
        border: 1.5px solid var(--border);
        border-radius: var(--border-radius-sm);
        background: var(--surface);
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: inherit;
        color: var(--text);
    }

    .preset-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .preset-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .info-box {
        background: #fffbeb;
        border: 1px solid #fde68a;
        border-radius: var(--border-radius-sm);
        padding: 14px 16px;
        margin-top: 20px;
        display: flex;
        align-items: start;
        gap: 12px;
    }

    .info-box i {
        color: #92400e;
        font-size: 18px;
        margin-top: 2px;
        flex-shrink: 0;
    }

    .info-box .content { flex: 1; padding: 0; }

    .info-box h4 {
        font-size: 14px;
        margin-bottom: 6px;
        color: #92400e;
        font-weight: 600;
    }

    .info-box p {
        font-size: 13px;
        color: #92400e;
        line-height: 1.5;
        margin: 0;
    }

    .info-box a { color: var(--primary); }

    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
        .section { padding: 20px; }
        .form-row { grid-template-columns: 1fr; }
        .btn-group { flex-direction: column; }
    }
</style>
{% endblock %}

{% block content %}
<form method="POST" action="{{ url_for('admin.save_email_settings') }}">
    <div class="section">
        <div class="section-title">
            <i class="fas fa-cog"></i>
            SMTP Configuration
        </div>

        <div class="provider-presets">
            <button type="button" class="preset-btn" onclick="setPreset('office365')">
                <i class="fab fa-microsoft"></i>
                Office 365
            </button>
            <button type="button" class="preset-btn" onclick="setPreset('gmail')">
                <i class="fab fa-google"></i>
                Gmail
            </button>
            <button type="button" class="preset-btn" onclick="setPreset('custom')">
                <i class="fas fa-server"></i>
                Custom
            </button>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="smtp_server">SMTP Server</label>
                <input type="text" id="smtp_server" name="smtp_server" class="form-control"
                       value="{{ config.smtp_server }}" placeholder="smtp.office365.com" required>
                <div class="help-text">The SMTP server address for sending emails</div>
            </div>
            <div class="form-group">
                <label for="smtp_port">Port</label>
                <input type="number" id="smtp_port" name="smtp_port" class="form-control"
                       value="{{ config.smtp_port }}" placeholder="587" required>
                <div class="help-text">Usually 587 for TLS</div>
            </div>
        </div>

        <div class="form-group">
            <label for="smtp_username">SMTP Username</label>
            <input type="text" id="smtp_username" name="smtp_username" class="form-control"
                   value="{{ config.smtp_username }}" placeholder="noreply@konsulence.al" required>
            <div class="help-text">Email account username (usually the full email address)</div>
        </div>

        <div class="form-group">
            <label for="smtp_password">SMTP Password</label>
            <input type="password" id="smtp_password" name="smtp_password" class="form-control"
                   value="{% if config.smtp_password %}••••••••{% endif %}" placeholder="Enter password" required>
            <div class="help-text">Email account password (stored securely)</div>
        </div>

        <div class="form-group">
            <label for="from_email">From Email Address</label>
            <input type="email" id="from_email" name="from_email" class="form-control"
                   value="{{ config.from_email }}" placeholder="noreply@konsulence.al" required>
            <div class="help-text">The email address that will appear in the "From" field</div>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="enabled" name="enabled" {% if config.enabled %}checked{% endif %}>
                <label for="enabled">Enable email notifications</label>
            </div>
            <div class="help-text">When disabled, the system will use environment variables instead</div>
        </div>

        {% if config.smtp_server == 'smtp.office365.com' %}
        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div class="content">
                <h4>Office 365 Setup Required</h4>
                <p>For Office 365 accounts, you must enable SMTP AUTH in the Microsoft 365 admin center. Go to Exchange Admin Center → Recipients → Mailboxes → select your mailbox → enable "Authenticated SMTP".</p>
            </div>
        </div>
        {% endif %}

        {% if config.smtp_server == 'smtp.gmail.com' %}
        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            <div class="content">
                <h4>Gmail Setup Required</h4>
                <p>Gmail requires 2-Step Verification and an App Password. Generate one at <a href="https://myaccount.google.com/apppasswords" target="_blank">myaccount.google.com/apppasswords</a></p>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="section">
        <div class="section-title">
            <i class="fas fa-flask"></i>
            Test Configuration
        </div>

        <div class="form-group">
            <label for="test_email">Test Email Address</label>
            <input type="email" id="test_email" name="test_email" class="form-control"
                   value="{{ config.test_email }}" placeholder="admin@konsulence.al">
            <div class="help-text">Send a test email to this address to verify settings</div>
        </div>

        <button type="button" class="btn btn-test" onclick="testEmail()">
            <i class="fas fa-paper-plane"></i>
            Send Test Email
        </button>

        <div id="test-result" class="test-result"></div>
    </div>

    <div class="btn-group">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            Save Settings
        </button>
        <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
            <i class="fas fa-times"></i>
            Cancel
        </a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    function setPreset(provider) {
        const presets = {
            'office365': { server: 'smtp.office365.com', port: 587 },
            'gmail': { server: 'smtp.gmail.com', port: 587 },
            'custom': { server: '', port: 587 }
        };

        const preset = presets[provider];
        if (preset) {
            document.getElementById('smtp_server').value = preset.server;
            document.getElementById('smtp_port').value = preset.port;
        }

        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.preset-btn').classList.add('active');
    }

    function testEmail() {
        const testEmail = document.getElementById('test_email').value;
        const resultDiv = document.getElementById('test-result');
        const testBtn = event.target;

        if (!testEmail) {
            resultDiv.className = 'test-result error';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please enter a test email address';
            return;
        }

        testBtn.disabled = true;
        testBtn.innerHTML = '<span class="spinner"></span> Sending...';

        fetch('{{ url_for("admin.test_email_settings") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'test_email=' + encodeURIComponent(testEmail)
        })
        .then(response => response.json())
        .then(data => {
            resultDiv.style.display = 'block';
            if (data.success) {
                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = '<i class="fas fa-check-circle"></i> ' + data.message;
            } else {
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> ' + data.message;
            }
        })
        .catch(error => {
            resultDiv.className = 'test-result error';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Failed to send test email: ' + error;
        })
        .finally(() => {
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Test Email';
        });
    }
</script>
{% endblock %}
